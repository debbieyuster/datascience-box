---
title: "Lab 05 - La Quinta is Spanish for *next to Denny's*, Pt. 2"
subtitle: "Wrangling spatial data"
output: 
  tufte::tufte_html:
    tufte_variant: "envisioned"
    highlight: pygments
    css: ../lab.css
link-citations: yes
---

```{r include=FALSE}
library(tufte)
library(knitr)
options(
  htmltools.dir.version = FALSE, # for blogdown
  show.signif.stars = FALSE,     # for regression output
  digits = 2
  )
knitr::opts_chunk$set(eval = FALSE)
```

```{r fig.margin=TRUE, eval=TRUE, echo=FALSE}
include_graphics("img/mitch-hedgeberg-lqd.jpg")
```

In this lab we revisit the Denny's and La Quinta Inn and Suites data we visualized in the previous lab.

## Getting started

Clone the groupâ€™s lab-05-wrangle-sp-data assignment repo (from GitHub) into RStudio (within our course workspace) and open the file lab-05-wrangle-sp-data.Rmd.

As you work, be sure to take turns with your groupmates. Only one person should type at a time (and should share their screen while typing). When that person is done, they should Knit, Commit, and Push their changes to GitHub. Then, everyone else should Pull the changes, and the next group member should take over typing and screen sharing.

Hopefully no merge conflicts will arise. If they do, take a deep breath, and resolve them. Ask for help if you need it. Importantly, if you encounter a merge conflict, everyone should stop what they're doing - don't continue working on the lab until the merge conflict is resolved, and everyone has Pulled the resolved files.

### Packages

In this lab we will use the **tidyverse** and **dsbox** packages.

```{r eval = FALSE}
library(tidyverse) 
library(dsbox) 
```

## Warm up

**Pick one team member to complete the steps in the Warm Up section while the others contribute to the discussion but do not actually touch the files on their computer.**

Before we introduce the data, let's warm up with some simple exercises.

### YAML 

Open the R Markdown (Rmd) file in your project, change the author name to your **team** name, and knit the document.

### Committing and pushing changes:

- Go to the **Git** pane in your RStudio. 
- View the **Diff** and confirm that you are happy with the changes.
- Add a commit message like "Update team name" in the **Commit message** box and hit **Commit**.
- Click on **Push**. This will prompt a dialogue box where you first need to enter your user name, and then your password.

### Pulling changes

Now, the remaining team members who have not been concurrently making these changes on their projects should click on the **Pull** button in their Git pane and observe that the changes are now reflected on their projects as well.

## The data

The datasets we'll use are called `dennys` and `laquinta` from the **dsbox** package. 

## Exercises

1. Filter the Denny's dataframe for Alaska (AK) and save the result as  `dn_ak`. How many Denny's locations are there in Alaska?
   
```{r}
dn_ak <- dennys %>%
  filter(state == "AK")
nrow(dn_ak)
```

2. Filter the La Quinta dataframe for Alaska (AK) and save the result as `lq_ak`. How many La Quinta locations are there in Alaska?
   
```{r}
lq_ak <- laquinta %>%
  filter(state == "AK")
nrow(lq_ak)
```

______________________________________
Next we'll calculate the distance between all Denny's and all La Quinta locations in Alaska. Let's take this step by step:

**Step 1:** There are 3 Denny's and 2 La Quinta locations in Alaska. 
(If you answered differently above, you might want to recheck your answers.)

![](img/dennys-laquinta-sketches/dennys-laquinta-sketches.001.png){width=300px height=300px}

**Step 2:** Let's focus on the first Denny's location. We'll need to 
calculate two distances for it: (a) distance between Denny's 1 and 
La Quinta 1 and (b) distance between Denny's 1 and La Quinta 2.

![](img/dennys-laquinta-sketches/dennys-laquinta-sketches.002.png){width=300px height=150px}

**Step 3:** Now let's consider all Denny's locations.

![](img/dennys-laquinta-sketches/dennys-laquinta-sketches.003.png){width=300px height=450px}

3. How many pairings are there between all Denny's and all La Quinta locations in Alaska, i.e. how many distances do we need to calculate between the  locations of these establishments in Alaska?

In order to calculate these distances we need to first restructure our data to pair the Denny's and La Quinta locations. To do so, we will join the two data frames. There are six join functions in R. Each of these join functions takes at least three arguments: `x`, `y`, and `by`.

- `x` and `y` are the data frames to join
- `by` is the variable(s) to join by

Four of these join functions, called **mutating joins**, *combine* variables from the two data frames:

- `inner_join()`: return all rows from `x` where there are matching values 
in `y`, and all columns from `x` and `y`.

- `left_join()`: return all rows from `x`, and all columns from `x` and `y`. 
Rows in x with no match in y will have NA values in the new columns.

- `right_join()`: return all rows from `y`, and all columns from `x` and `y`. 
Rows in y with no match in x will have NA values in the new columns.

- `full_join()`: return all rows and all columns from both `x` and `y`. Where 
there are not matching values, returns NA for the one missing.

The other two join functions only keep cases from the left-hand data frame, 
and are called **filtering joins**. We won't be using those in this lab, but 
you can find out more about all the join functions in the help files for any one 
of them, e.g. `?full_join`.

In practice we mostly use mutating joins. In our case, we want to keep all 
rows and columns from both the `dn_ak` and the `lq_ak` data frames. So we will use 
a `full_join`.

![Full join of Denny's and La Quinta locations in AK](img/dennys-laquinta-sketches/dennys-laquinta-sketches.004.png){height=300px width=300px}

Let's join the data on Denny's and La Quinta locations in Alaska, and take 
a look at the result:

```{r}
dn_lq_ak <- full_join(dn_ak, lq_ak, by = "state")
dn_lq_ak
```

4. How many observations are in the joined `dn_lq_ak` data frame? What are the names of the variables in this data frame? Use inline code to answer this question. 
   
`.x` in the variable names means the variable comes from the `x` data frame 
(the first argument in the `full_join` call, i.e. `dn_ak`), and `.y` means 
the variable comes from the `y` data frame. These varibles are renamed to 
include `.x` and `.y` because the two data frames have the same variables 
and it's not possible to have two variables in a data frame with the exact 
same name.

Now that we have the data in the format we wanted, let's 
calculate the distances between the pairs.

5.  What function from the tidyverse do we use to add a new variable to a data frame while keeping the existing variables?

One way of calculating the distance between any two points on the earth is to use the Haversine distance formula. This formula takes into account the fact that the earth is not flat, but instead (almost) spherical.

This function is built in to R, but you can define (and then use) the `haversine` function by including the code below in your lab report:

```{r}
haversine <- function(long1, lat1, long2, lat2, round = 3) {
  # convert to radians
  long1 = long1 * pi / 180
  lat1  = lat1  * pi / 180
  long2 = long2 * pi / 180
  lat2  = lat2  * pi / 180
  
  R = 6371 # Earth mean radius in km
  
  a = sin((lat2 - lat1)/2)^2 + cos(lat1) * cos(lat2) * sin((long2 - long1)/2)^2
  d = R * 2 * asin(sqrt(a))
  
  return( round(d,round) ) # distance in km
}
```

This function takes five arguments:

- Longitude and latitude of the first location
- Longitude and latitude of the second location
- A parameter by which to round the responses

6. Create a variable called `distance` in the `dn_lq_ak` data frame, which calculates the distances between all pairs of Denny's and La Quinta locations in Alaska. Make sure to save this variable in the data frame so you can use it later.
   
7. Calculate the minimum distance between Denny's and La Quinta for each Denny's location in Alaska. To do so, create a new data frame called `dn_lq_ak_mindist` which starts from the data frame  `dn_lq_ak`, groups it by Denny's locations (`address.x`), and then uses the `summarise` function to create a new variable which contains the minimum distance within each group (in other words, the minimum distance from each Denny's location). Finally, ungroup the resulting table.

8. Describe the distribution of the distances between Denny's and the nearest La Quinta locations in Alaska. Also include an appropriate visualization and relevant summary statistics (using the `summary` function). 
   
9. Repeat the same analysis for New Jersey: (i) filter the Denny's and La Quinta data frames for NJ, (ii) join these data frames to get a complete list of all possible pairings, (iii) calculate the distances between all possible pairings of Denny's and La Quinta in NJ, (iv) find the minimum distance between each Denny's and La Quinta location, (v) visualize and describe the distribution of these shortest distances using appropriate summary statistics.

10. Repeat the same analysis for Texas.

11. Repeat the same analysis for a state of your choosing, different than the ones we've looked at so far.
    
12. Among the states you examined, where is Mitch Hedberg's joke most likely to hold true? Explain your reasoning.

## Wrapping up and Submission

Make any final changes, and be sure you've followed code style guidelines.

To submit, one team member should upload the team's PDF to Gradescope. **Be sure to select every team member's name in the Gradescope submission**. Mark where each answer is to the exercises, and associate the "Overall" question with the first page of your PDF. If any answer spans multiple pages, then mark each of the relevant pages. The "Overall" points will be given for things like proper GitHub usage and code style. Group members who have not participated sufficiently may receive a lower grade than the rest of the group.

There should only be **<u>one</u>** submission per team on Gradescope. 
    